name: Visitor Meadow

on:
  issues:
    types: [opened]

jobs:
  add_plant:
    if: contains(github.event.issue.labels.*.name, 'meadow')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Read issue body
        id: getbody
        run: echo "body<<EOF" >> $GITHUB_OUTPUT && echo "${{ github.event.issue.body }}" >> $GITHUB_OUTPUT && echo "EOF" >> $GITHUB_OUTPUT

      - name: Determine plant type
        id: plant
        run: |
          body="${{ steps.getbody.outputs.body }}"
          if echo "$body" | grep -qi "flower"; then
            echo "icon=ðŸŒ¸" >> $GITHUB_OUTPUT
            echo "type=flower" >> $GITHUB_OUTPUT
          elif echo "$body" | grep -qi "leaf"; then
            echo "icon=ðŸŒ¿" >> $GITHUB_OUTPUT
            echo "type=leaf" >> $GITHUB_OUTPUT
          elif echo "$body" | grep -qi "mushroom"; then
            echo "icon=ðŸ„" >> $GITHUB_OUTPUT
            echo "type=mushroom" >> $GITHUB_OUTPUT
          else
            echo "icon=ðŸŒ±" >> $GITHUB_OUTPUT
            echo "type=sprout" >> $GITHUB_OUTPUT
          fi

      - name: Add plant to meadow.json
        run: |
          icon="${{ steps.plant.outputs.icon }}"
          type="${{ steps.plant.outputs.type }}"
          x=$(( RANDOM % 100 ))
          y=$(( RANDOM % 100 ))
          jq ". += [{\"type\":\"$type\",\"icon\":\"$icon\",\"x\":$x,\"y\":$y}]" data/meadow.json > data/tmp.json
          mv data/tmp.json data/meadow.json

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add data/meadow.json
          git commit -m "Add ${{ steps.plant.outputs.type }} to meadow" || echo "No changes to commit"
      - name: Fix remote url
        run: |
          git remote set-url origin https://github.com/CeciliaLof/cecilialof.github.io.git
      - name: Push changes
        run: git push

      - name: Close issue
        uses: peter-evans/close-issue@v2
        with:
          issue-number: ${{ github.event.issue.number }}
          comment: "Your plant has been added to the meadow ðŸŒ¼"
